{%extends "training/base.html"%}

{%block content%}

<h2>workout #{{workout.id}}</h2>

{%if workout.live%}
<div class="box">
    <dl>
        <dt>duration</dt><dd><span id="stopwatch">--:--</span></dd>
        <dt>total reps</dt><dd>{{workout.total_reps}}</dd>
    </dl>
</div>

<div class="box">
    <form action="{% url 'finish_workout' workout.id %}" method="post">
        {% csrf_token %}
        <input type="submit" value="finish" />
    </form>
</div>
{%endif%}

{%if not workout.started%}
<div class="box">this workout has not beed started yet, add first excercise to do it</div>
{%endif%}

{%if workout.finished%}
<div class="box">
    <dl>
        <dt>started</dt><dd>{{workout.started}}</dd>
        <dt>took</dt><dd>{{workout.started|timesince:workout.finished}}</dd>
        <dt>total reps</dt><dd>{{workout.total_reps}}</dd>
    </dl>
</div>
{%endif%}

<h2>excercises</h2>
{%for excercise in workout.excercise_set.all%}
    <div class="excercise box">
        <span class="name">{{excercise.name}}</span>

        {%for reps in excercise.reps_set.all%}
            <span class="reps">{{reps.reps}}</span>
        {%endfor%}

        {%if excercise.total_reps > 0%}
            <span class="total_reps reps">({{excercise.total_reps}})</span>
        {%endif%}
    </div>

    {%if forloop.last and not workout.finished%}
        <div class="box">
            <form action="{% url 'add_reps' excercise.id %}" method="post">
                {% csrf_token %}
                <input type="number" id="sets_{{ excercise.id }}" name="reps" value="{{ excercise.sets }}" placeholder="reps" required />
                <input type="submit" value="add" />
            </form>

            {%for rep,_ in most_common_reps%}
                <form action="{% url 'add_reps' excercise.id %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="reps" value="{{rep}}" />
                    <input type="submit" value="+{{rep}}" />
                </form>
            {%endfor%}
        </div>
    {%endif%}
{%empty%}
    <div class="box">you will be counting your reps here</div>
{%endfor%}

{%if not workout.finished%}
<h2>start new excercise</h2>
<div class="major box">
    <form action="{% url 'add_excercise' workout.id %}" method="post">
            {% csrf_token %}
            <input type="text" id="new_excercise_name" name="name" placeholder="name" required />
            <input type="submit" value="start" />
    </form>
</div>
{%endif%}

{%if workout.finished%}
<h2>UTD string</h2>
<div class="box">
    <pre>{{ workout.utd }}</pre>
</div>
{%endif%}

<script>
    function update_stopwatch(start_time)
    {
        now = new Date();

        var diff = now.getTime() - start_time.getTime();

        document.getElementById('stopwatch').innerHTML = format_time(diff);
        refresh = setTimeout(function() { update_stopwatch(start_time); }, 500);
    }

    function format_time(ms)
    {
        var second = Math.floor(ms/1000);
        var minute = Math.floor(ms/60000);
        second = second - 60 * minute + '';
        return minute + 'm ' + second + 's';
    }

    window.onload = function()
    {
        var start_time = new Date("{{workout.started.isoformat}}");
        update_stopwatch(start_time);
    };
</script>

{%endblock%}
