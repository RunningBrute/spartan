{% load training_format %}
{% load staticfiles %}

<link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">
<script src="https://openlayers.org/en/v3.19.1/build/ol.js"></script>
<script src="{% static 'training/activity_charts.js' %}"></script>

<h2>{{ gpx.activity_type }}, {{ workout.started }}</h2>
<section>
    <dl class="metric"><dt>distance</dt><dd>{{ gpx.distance|distance }}</dd></dl>
    <dl class="metric"><dt>time</dt><dd>{{ workout.duration }}</dd></dl>
    <dl class="metric"><dt>pace</dt><dd>{{ gpx.speed_or_pace }}</dd></dl>

    {% if gpx.average_hr %}
        <dl class="metric"><dt>avg hr</dt><dd>{{ gpx.average_hr }}</dd></dl>
    {% endif %}
    {% if gpx.average_cad %}
        <dl class="metric"><dt>avg cadence</dt><dd>{{ gpx.average_cad }}</dd></dl>
    {% endif %}
</section>

<section>
    <div id="map" style="height: 350px"></div>
</section>

<script>
function makeGpsLayer(json) {
    var polyline_points = points.map(function (point){ return [point.lon, point.lat]; });

    var track = new ol.geom.LineString(polyline_points).transform('EPSG:4326', 'EPSG:3857');

    var featureLine = new ol.Feature({
        geometry: track
    });

    var sourceLine = new ol.source.Vector({
        features: [featureLine]
    });

    var styles = [
        new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'white',
                width: 6
            })
        }),

        new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#3399ff',
                width: 3
            })
        })
    ]

    var layer = new ol.layer.Vector({
        source: sourceLine,

        style: styles
    });

    return layer
}

function renderMap(target, layer) {
    var osmLayer = new ol.layer.Tile({source: new ol.source.OSM()})

    var map = new ol.Map({
            layers: [osmLayer, layer],
            target: target
        });

    map.getView().fit(layer.getSource().getExtent(), map.getSize());
}

var points = {{ gpx.points_as_json|safe }};

renderMap('map', makeGpsLayer(points));

</script>

{% block content %}

<section>
    <canvas id="charts" width="8" height="1"></canvas>
    <canvas id="pace1" width="8" height="1"></canvas>
    <canvas id="pace2" width="8" height="1"></canvas>

    <script>
    $(document).ready(function() {
        render_charts('#charts', '#pace1', '#pace2', {{ gpx.points_as_json|safe }}, {{ gpx.average_hr }}, {{ gpx.average_cad|default_if_none:'null' }});
    });
    </script>

</section>

{% endblock %}
