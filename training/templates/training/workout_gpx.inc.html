{% load training_format %}

<link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">
<script src="https://openlayers.org/en/v3.19.1/build/ol.js"></script>

<h2>{{ gpx.activity_type }}, {{ workout.started }}</h2>
<section>
    <dl class="metric"><dt>distance</dt><dd>{{ gpx.distance|distance }}</dd></dl>
    <dl class="metric"><dt>time</dt><dd>{{ workout.duration }}</dd></dl>
    <dl class="metric"><dt>pace</dt><dd>{{ gpx.speed_or_pace }}</dd></dl>

    {% if gpx.average_hr %}
        <dl class="metric"><dt>avg hr</dt><dd>{{ gpx.average_hr }}</dd></dl>
    {% endif %}
    {% if gpx.average_cad %}
        <dl class="metric"><dt>avg cadence</dt><dd>{{ gpx.average_cad }}</dd></dl>
    {% endif %}
</section>

<section>
    <div id="map" style="height: 350px"></div>
</section>

<script>

var osmLayer = new ol.layer.Tile({source: new ol.source.OSM()})

var points = {{ gpx.points_as_json|safe }};
var polyline_points = points.map(function (point){ return [point.lon, point.lat]; });

var track = new ol.geom.LineString(polyline_points).transform('EPSG:4326', 'EPSG:3857');

var featureLine = new ol.Feature({
    geometry: track
  });

var sourceLine = new ol.source.Vector({
    features: [featureLine]
  });

var styles = [
    new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: 'white',
            width: 6
        })
    }),

    new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: '#3399ff',
            width: 3
        })
    })
]

var gpxLayer = new ol.layer.Vector({
    source: sourceLine,

    style: styles
  });

var map = new ol.Map({
        layers: [osmLayer, gpxLayer],
        target: 'map'
      });

map.getView().fit(gpxLayer.getSource().getExtent(), map.getSize());

</script>

{% if gpx.average_hr %}
{% block content %}

<section>
    <canvas id="charts" width="12" height="1"></canvas>
    <script>
        Chart.defaults.global.elements.rectangle.borderColor = 'rgba(207, 74, 8, 0.8)';
        Chart.defaults.global.elements.rectangle.backgroundColor = 'rgba(207, 74, 8, 0.8)';

        Chart.defaults.global.elements.line.borderColor = 'rgba(207, 74, 8, 0.8)';
        Chart.defaults.global.elements.line.backgroundColor = 'rgba(207, 74, 8, 0.05)';
        Chart.defaults.global.legend.display = true;
        Chart.defaults.global.legend.position = "right";

        Chart.defaults.global.defaultFontColor = 'rgba(160, 160, 160, 0.8)';
        Chart.defaults.global.defaultFontFamily = 'Helvetica';
        Chart.defaults.global.defaultFontSize = 12;
        Chart.defaults.global.defaultFontStyle = "Bold";

        {% load training_format %}

	var points = {{ gpx.points_as_json|safe }};
        var hr_data = points.map(function (point){ return point.hr; });
	var cad_data = points.map(function (point){ return point.cad; });
	var one_minute_in_milliseconds = 1000.0*60.0;
	var time_data = points.map(function (point)
		{
			var started_time = new Date(points[0].time).getTime();
			var actual_time = new Date(point.time).getTime();
			var delta_time_in_ms = actual_time - started_time;
			const one_minute_in_ms = 1000 * 60;

			return Math.floor(delta_time_in_ms / one_minute_in_ms);
		});

        avg_hr_data = [];
        avg_cad_data = [];

        {% if gpx.average_hr %}
            avg_hr_data = new Array(hr_data.length);
            avg_hr_data.fill({{ gpx.average_hr }});
        {% endif %}

        {% if gpx.average_cad %}
            avg_cad_data = new Array(cad_data.length);
            avg_cad_data.fill({{ gpx.average_cad }});
        {% endif %}

        ctx = $('#charts');
        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: time_data,
                datasets: [{
                    borderColor: "rgba(153, 0, 0, 0.8)",
                    backgroundColor: "rgba(153, 0, 0, 0.1)",
                    label: "Heart rate",
                    fill: true,
                    cubicInterpolationMode: "monotone",
                    pointRadius: 0,
                    data: hr_data
                },
                {
                    borderColor: "rgba(153, 0, 0, 0.4)",
                    backgroundColor: "rgba(153, 0, 0, 0)",
                    label: "Avg HR",
                    fill: false,
                    pointRadius: 0,
                    data: avg_hr_data
                },
                {
                    borderColor: "rgba(0, 76, 153, 0.8)",
                    backgroundColor: "rgba(0, 76, 153, 0.1)",
                    label: "Cadence",
                    fill: true,
                    pointRadius: 0,
                    data: cad_data
                },
                {
                    borderColor: "rgba(0, 76, 153, 0.4)",
                    backgroundColor: "rgba(0, 76, 153, 0)",
                    label: "Avg cad",
                    fill: false,
                    pointRadius: 0,
                    data: avg_cad_data
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        gridLines: {
                            color: "rgba(207, 74, 8, 0.1)"
                        },
                        ticks: {
                            beginAtZero: false
                        }
                    }],
                    xAxes: [{
                        gridLines: {
                            color: "rgba(207, 74, 8, 0.1)"
                        },
                        ticks: {
                            maxTicksLimit: 15,
                            minRotation: 0, 
                            maxRotation: 0
                        }
                    }],
                }
            }
        }); 
    </script>
</section>

{% endblock %}
{% endif %}

